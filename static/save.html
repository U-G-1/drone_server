<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>드론 좌표 저장</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; padding: 16px; }
    .row { margin: 8px 0; }
    input, button { padding: 8px; font-size: 16px; }
    #pos { font-weight: 600; }
    .video-container { margin-top:16px; }
    #consoleOutput {
      background:#000; color:#0f0; padding:10px;
      border-radius:6px; height:320px; overflow:auto; margin-top:12px;
    }

  </style>
</head>
<body>
  <h2>드론 좌표 저장</h2>

  <div class="row">
    <input id="chim" placeholder="굴뚝 이름 (chim_name)" />
    <button id="setChim">굴뚝 선택</button>
    <small id="chimStatus"></small>
  </div>

  <div class="row">
    <div>실시간 좌표(1초 갱신):</div>
    <div id="pos">x: -, y: -, z: -, slope: -</div>
  </div>

  <div class="row">
    <button id="saveBtn" disabled>저장</button>
    <small id="saveMsg"></small>
  </div>
  <!-- Camera -->
<div class="video-container">
  <h3>Camera Feeds</h3>
  <iframe id="camera1"
          src="https://droneview.ngrok.app/index.html"
          width="100%" height="420"
          frameborder="0" allowfullscreen>
  </iframe>
</div>

<!-- Console -->
<h3>Server Console Output</h3>
<div id="consoleOutput"></div>


<script>
  // ---- 굴뚝 이름 유지 (localStorage)
  const chimInput = document.getElementById('chim');
  const chimStatus = document.getElementById('chimStatus');
  chimInput.value = localStorage.getItem('chimneyNumber') || '';
  chimInput.addEventListener('input', () => {
    localStorage.setItem('chimneyNumber', chimInput.value);
  });

  document.getElementById('setChim').onclick = async () => {
    const chimneyNumber = chimInput.value.trim();
    if (!chimneyNumber) { alert('굴뚝 이름을 입력하세요'); return; }
    const r = await fetch('/saveLocation', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ chimneyNumber })
    });
    if (!r.ok) { chimStatus.textContent = '쿠키 설정 실패'; return; }
    chimStatus.textContent = '쿠키 설정됨';
  };

  // ---- 실시간 좌표 표시 (WebSocket)
  // 서버에서 드론/컨트롤러가 /telemetry/ingest 로 넣으면,
  // 백엔드가 /ws/telemetry로 {type:'telemetry', data:{x,y,z,slope,...}} 브로드캐스트
  const posEl = document.getElementById('pos');
  const saveBtn = document.getElementById('saveBtn');
  const saveMsg = document.getElementById('saveMsg');
  let latest = null;
  let lastTs = 0;

  function updateBtnState() {
    // 최근 3초 내 좌표가 있으면 저장 버튼 활성화
    const fresh = (Date.now() - lastTs) < 3000;
    saveBtn.disabled = !fresh;
  }

  const wsProtocol = location.protocol === "https:" ? "wss:" : "ws:";  
  const ws = new WebSocket(`${wsProtocol}//${location.host}/ws/telemetry`);

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (data.type === "telemetry") {
      // 좌표 표시
      latest = data.data;
      lastTs = Date.now();
      pos.textContent = `x: ${latest.x}, y: ${latest.y}, z: ${latest.z}`;
    } else if (data.type === "consoleMessage") {
      log(data.data);  // Server Console Output에 찍기
    }
  };
  ws.onclose = () => {
    posEl.textContent = '실시간 연결 종료됨 (WS 닫힘)';
    saveBtn.disabled = true;
  };
  setInterval(updateBtnState, 1000);

  const consoleOutput = document.getElementById('consoleOutput');
  function log(msg) {
    const d = document.createElement('div');
    d.textContent = msg;
    consoleOutput.appendChild(d);
    consoleOutput.scrollTop = consoleOutput.scrollHeight;
  }

  // ---- 저장 (프론트 주도 방식: 최신 좌표 + chim_name을 바로 POST)
  saveBtn.onclick = async () => {
    if (!latest) { alert('아직 좌표가 없습니다'); return; }
    const chim_name = chimInput.value.trim();
    if (!chim_name) { alert('굴뚝 이름을 입력하세요'); return; }

    // 방법 A: 기존 /telemetry 엔드포인트 사용 (프론트 주도)
    // 서버에 TelemetryIn(x,y,z,slope, tag=chim_name) 매핑되어 있어야 함
    const payload = {
      x: latest.x,
      y: latest.y,
      z: latest.z,
      slope: latest.slope ?? null,
      tag: chim_name
    };

    try {
      const r = await fetch('/telemetry', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await r.json();
      if (!r.ok) throw new Error(data.detail || '저장 실패');
      saveMsg.textContent = `저장 완료: ${chim_name}`;
      setTimeout(()=> saveMsg.textContent = '', 2000);
    } catch (err) {
      console.error(err);
      alert('저장 실패: ' + err.message);
    }
  };
</script>
</body>
</html>
