<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>드론 테스트 (Arm / Takeoff)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; padding: 16px; }
    .row { margin: 10px 0; }
    #pos { font-weight: 600; }
    #log { background:#111; color:#0f0; height:260px; overflow:auto; padding:8px; border-radius:8px; }
    fieldset { border:1px solid #ddd; padding:10px; border-radius:8px; }
    button { padding:8px 14px; font-size:16px; }
    input[type="number"] { width: 100px; padding:6px; }
  </style>
</head>
<body>
  <h2>드론 테스트</h2>

  <div class="row">
    <div>실시간 좌표(1초 갱신):</div>
    <div id="pos">x: -, y: -, z: -, slope: -</div>
  </div>

  <form id="cmdForm" class="row" onsubmit="return false;">
    <!-- fieldset 안의 라디오 그룹 부분만 변경 -->
    <fieldset>
    <legend>명령 선택</legend>
    <label><input type="radio" name="action" value="arm" checked> Arm</label>
    <label style="margin-left:16px;"><input type="radio" name="action" value="takeoff"> Takeoff</label>
    <label style="margin-left:16px;"><input type="radio" name="action" value="land"> Land</label>
    <label style="margin-left:16px;">고도(m):
        <input type="number" id="alt" step="0.1" value="5">
    </label>
    <button id="run">실행</button>
    </fieldset>

  </form>

  <div class="row">
    <h3 style="margin:8px 0;">로그</h3>
    <div id="log"></div>
  </div>

<script>
  // --- 실시간 좌표(WebSocket) ---
  const posEl = document.getElementById('pos');
  const wsProtocol = location.protocol === "https:" ? "wss:" : "ws:";
  const ws = new WebSocket(`${wsProtocol}//${location.host}/ws/telemetry`);

  ws.onmessage = (e) => {
    try {
      const m = JSON.parse(e.data);
      if (m.type === 'telemetry') {
        const d = m.data;
        posEl.textContent = `x: ${d.x}, y: ${d.y}, z: ${d.z}, slope: ${d.slope ?? '-'}`;
      } else if (m.type === 'consoleMessage') {
        log(m.data);
      }
    } catch {}
  };
  ws.onclose = () => log('WS closed');

  // --- 명령 전송(Arm/Takeoff) ---
  const logBox = document.getElementById('log');
  function log(msg) {
    const div = document.createElement('div');
    div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    logBox.appendChild(div);
    logBox.scrollTop = logBox.scrollHeight;
  }

  document.getElementById('run').onclick = async () => {
    const action = [...document.querySelectorAll('input[name="action"]')].find(r => r.checked).value;
    const alt = parseFloat(document.getElementById('alt').value || '5');

    log(`요청: ${action}${action==='takeoff' ? ` (alt=${alt}m)` : ''}`);
    try {
      const r = await fetch('/test/command', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ action, altitude: alt })
      });
      const data = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(data.detail || r.statusText);
      log(`응답: ${JSON.stringify(data)}`);
    } catch (e) {
      log(`에러: ${e.message}`);
      alert('실패: ' + e.message);
    }
  };
</script>
</body>
</html>
